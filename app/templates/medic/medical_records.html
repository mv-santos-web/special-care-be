{% extends "includes/layout.html" %}
{% block title %}Prontuários{% endblock %}
{% block styles %}
<style>
    .dataTables_length {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
    }

    .dataTables_length select {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
        margin-left: 5px;
        margin-right: 5px;
        padding: 2px;
        border-radius: 10px !important;
        border: 1px solid var(--orange) !important;
        text-align: center;
    }

    .dataTables_filter input {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
        margin-left: 5px;
        margin-right: 5px;
        padding: 3px;
        border-radius: 10px !important;
        border: 1px solid var(--orange) !important;
    }

    .dataTables_info {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
    }

    /* Pagination Container */
    .dataTables_paginate {
        margin: 0;
        padding: 1rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    /* Pagination Buttons */
    .dataTables_paginate .paginate_button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--blueDark);
        border: 1px solid var(--orange);
        border-radius: 0.375rem !important;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }

    /* Hover State */
    .dataTables_paginate .paginate_button:hover {
        background-color: var(--orange);
        color: white !important;
        border-color: var(--orange);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Active/Current Page */
    .dataTables_paginate .paginate_button.current,
    .dataTables_paginate .paginate_button.current:hover {
        background-color: var(--orange);
        color: white !important;
        border-color: var(--orange);
        font-weight: 800;
    }

    /* Disabled Buttons */
    .dataTables_paginate .paginate_button.disabled,
    .dataTables_paginate .paginate_button.disabled:hover,
    .dataTables_paginate .paginate_button.disabled:active {
        color: var(--orange) !important;
        background-color: var(--orange) !important;
        border-color: var(--orange) !important;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Navigation Buttons (Previous/Next) */
    .dataTables_paginate .paginate_button.previous,
    .dataTables_paginate .paginate_button.next {
        background-color: #f0f0f0 !important;
        border: 1px solid var(--orange) !important;
        color: var(--blueDark) !important;
        font-weight: 800;
        border-radius: 0.375rem !important;
    }

    .dataTables_paginate .paginate_button.previous:hover,
    .dataTables_paginate .paginate_button.next:hover {
        background-color: var(--orange) !important;
        color: white !important;
        border-color: var(--blueDark) !important;
    }

    /* Ellipsis */
    .dataTables_paginate .ellipsis {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--orange);
    }
</style>
{% endblock %}

{% block content %}
<!-- jQuery Mask Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-[var(--blueDark)]">Prontuários</h1>
        <p class="text-gray-600">Gerencie os prontuários do sistema</p>
    </div>

    <!-- Add New Admin Button -->
    <div>
        <button id="addConsultBtn"
            class="bg-[var(--orange)] hover:bg-[var(--orangeDark)] text-white px-4 py-2 rounded-lg flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
                </path>
            </svg>
            Novo Prontuário
        </button>
    </div>
</div>
<!-- Admins Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-4">
        <table id="consultsTable" class="w-full">
            <thead>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <!-- Data will be loaded via AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- View Admin Modal -->
<div id="viewConsultModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-opacity duration-300 overflow-y-auto">
    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl transform transition-all duration-300 ease-out flex flex-col">
        <!-- Scrollable Content -->
        <div class="overflow-y-auto flex-1 p-6 pt-0">
            <!-- Patient Info Card -->
            <div class="bg-gray-50 rounded-xl p-4 sm:p-6 border border-gray-100 mb-6">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-100 p-2 rounded-lg mr-3 flex-shrink-0">
                        <svg class="h-5 w-5 sm:h-6 sm:w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <h4 class="text-base sm:text-lg font-semibold text-gray-900">Informações do Paciente</h4>
                </div>
                <div class="space-y-3">
                    <div>
                        <p id="view-patient" class="text-lg sm:text-xl font-bold text-gray-900 break-words"></p>
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-600 mt-1">
                            <span id="view-patient-age" class="flex items-center"></span>
                            <span id="view-patient-gender" class="flex items-center"></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-3 border-t border-gray-100">
                        <div class="space-y-2">
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Contato</p>
                            <div class="space-y-2">
                                <p id="view-patient-phone" class="text-gray-700 flex items-start">
                                    <svg class="h-4 w-4 text-gray-400 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                    </svg>
                                    <span class="break-all"></span>
                                </p>
                                <p id="view-patient-email" class="text-gray-700 flex items-start">
                                    <svg class="h-4 w-4 text-gray-400 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                    <span class="break-all"></span>
                                </p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wider">Documentos</p>
                            <div class="space-y-2">
                                <p id="view-patient-cpf" class="text-gray-700 flex items-start">
                                    <svg class="h-4 w-4 text-gray-400 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <span class="break-all"></span>
                                </p>
                                <p id="view-patient-address" class="text-gray-700 flex items-start">
                                    <svg class="h-4 w-4 text-gray-400 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <span class="break-all"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical Sections -->
            <div class="space-y-4 sm:space-y-6">
                <!-- Medical History -->
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 border-b border-gray-200">
                        <h4 class="font-medium text-gray-900 flex items-center text-sm sm:text-base">
                            <svg class="h-4 w-4 sm:h-5 sm:w-5 text-gray-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Histórico Médico
                        </h4>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div id="view-medic_history" class="prose prose-sm max-w-none text-gray-700 whitespace-pre-line break-words"></div>
                    </div>
                </div>

                <!-- Medicines -->
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 border-b border-gray-200">
                        <h4 class="font-medium text-gray-900 flex items-center text-sm sm:text-base">
                            <svg class="h-4 w-4 sm:h-5 sm:w-5 text-gray-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                            </svg>
                            Medicamentos
                        </h4>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div id="view-medicines" class="prose prose-sm max-w-none text-gray-700 whitespace-pre-line break-words"></div>
                    </div>
                </div>

                <!-- Observations -->
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 border-b border-gray-200">
                        <h4 class="font-medium text-gray-900 flex items-center text-sm sm:text-base">
                            <svg class="h-4 w-4 sm:h-5 sm:w-5 text-gray-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            Observações
                        </h4>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div id="view-observations" class="prose prose-sm max-w-none text-gray-700 whitespace-pre-line break-words"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end flex-shrink-0">
            <button type="button" 
                    onclick="closeModal('viewConsultModal')"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--orange)] transition-colors duration-200">
                Fechar
            </button>
        </div>
    </div>
</div>

<!-- Edit Admin Modal -->
<div id="editConsultModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-opacity duration-300 overflow-y-auto">
    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl transform transition-all duration-300 ease-out flex flex-col">
        <!-- Scrollable Content -->
        <div class="overflow-y-auto flex-1 p-6 pt-0">
            <form id="editConsultForm" class="space-y-6">
                <input type="hidden" id="edit-id" name="id">
                
                <!-- Patient Info Card -->
                <div class="bg-gray-50 rounded-xl p-6 border border-gray-100 mb-6">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 p-2 rounded-lg mr-3">
                            <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-900">Informações do Paciente</h4>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                            <div>
                                <label for="edit-patient" class="block text-sm font-medium text-gray-700 mb-1">Paciente *</label>
                                <select id="edit-patient" name="patient" required
                                    class="mt-1 block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 focus:border-[var(--orange)] focus:outline-none focus:ring-1 focus:ring-[var(--orange)] sm:text-sm">
                                    <option value="">Selecione um paciente</option>
                                    {% for patient in patients %}
                                    <option value="{{ patient.id }}">{{ patient.fullname }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Medical Sections -->
                <div class="space-y-6">
                    <!-- Medical History -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                            <h4 class="font-medium text-gray-900 flex items-center">
                                <svg class="h-5 w-5 text-gray-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Histórico Médico *
                            </h4>
                        </div>
                        <div class="p-6">
                            <textarea id="edit-medic_history" name="medic_history" required rows="4"
                                class="block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 focus:border-[var(--orange)] focus:outline-none focus:ring-1 focus:ring-[var(--orange)] sm:text-sm rich-text-editor"
                                placeholder="Descreva o histórico médico do paciente"></textarea>
                        </div>
                    </div>

                    <!-- Medicines -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                            <h4 class="font-medium text-gray-900 flex items-center">
                                <svg class="h-5 w-5 text-gray-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                </svg>
                                Medicamentos *
                            </h4>
                        </div>
                        <div class="p-6">
                            <textarea id="edit-medicines" name="medicines" required rows="4"
                                class="block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 focus:border-[var(--orange)] focus:outline-none focus:ring-1 focus:ring-[var(--orange)] sm:text-sm rich-text-editor"
                                placeholder="Liste os medicamentos em uso"></textarea>
                        </div>
                    </div>

                    <!-- Observations -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                            <h4 class="font-medium text-gray-900 flex items-center">
                                <svg class="h-5 w-5 text-gray-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Observações *
                            </h4>
                        </div>
                        <div class="p-6">
                            <textarea id="edit-observations" name="observations" required rows="4"
                                class="block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 focus:border-[var(--orange)] focus:outline-none focus:ring-1 focus:ring-[var(--orange)] sm:text-sm rich-text-editor"
                                placeholder="Adicione observações relevantes"></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
            <button type="button" 
                    onclick="closeModal('editConsultModal')"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--orange)] transition-colors duration-200">
                Cancelar
            </button>
            <button type="submit" 
                    form="editConsultForm"
                    class="ml-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-[var(--orange)] hover:bg-[var(--orange-dark)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--orange)] transition-colors duration-200">
                <svg class="-ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Salvar Alterações
            </button>
        </div>
    </div>
</div>

<!-- Add Medical Record Modal -->
<div id="addConsultModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-opacity duration-300">
    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
        <form id="addConsultForm" class="flex flex-col h-full overflow-y-auto" action="{{ url_for('medic.medical_record_medic_add') }}" method="post" enctype="multipart/form-data">
            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Patient Selection -->
                <div class="bg-gray-50 rounded-xl p-6 border border-gray-100 mb-6">
                    <h4 class="font-medium text-gray-900 flex items-center mb-4">
                        <svg class="h-5 w-5 text-gray-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        Dados do Paciente
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label for="patient_id" class="block text-sm font-medium text-gray-700 mb-1">Paciente *</label>
                            <select id="patient_id" name="patient_id" required 
                                class="mt-1 block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 focus:border-[var(--orange)] focus:outline-none focus:ring-1 focus:ring-[var(--orange)] sm:text-sm">
                                <option value="">Selecione um paciente</option>
                                {% for patient in patients %}
                                <option value="{{ patient.id }}">{{ patient.fullname }} - {{ patient.cpf if patient.cpf else '' }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Medical Information -->
                <div class="space-y-6">
                    <!-- Medical History -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                            <h4 class="font-medium text-gray-900 flex items-center">
                                <svg class="h-5 w-5 text-gray-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Histórico Médico
                            </h4>
                        </div>
                        <div class="p-6">
                            <textarea id="medic_history" name="medic_history" required rows="6" 
                                class="block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 focus:border-[var(--orange)] focus:outline-none focus:ring-1 focus:ring-[var(--orange)] sm:text-sm rich-text-editor"
                                placeholder="Descreva o histórico médico do paciente, incluindo condições pré-existentes, alergias, cirurgias anteriores, etc."></textarea>
                        </div>
                    </div>

                    <!-- Medications -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                            <h4 class="font-medium text-gray-900 flex items-center">
                                <svg class="h-5 w-5 text-gray-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                </svg>
                                Medicamentos
                            </h4>
                        </div>
                        <div class="p-6">
                            <textarea id="medicines" name="medicines" required rows="4"
                                class="block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 focus:border-[var(--orange)] focus:outline-none focus:ring-1 focus:ring-[var(--orange)] sm:text-sm rich-text-editor"
                                placeholder="Liste os medicamentos prescritos, incluindo dosagem e frequência."></textarea>
                        </div>
                    </div>

                    <!-- Observations -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b border-gray-200">
                            <h4 class="font-medium text-gray-900 flex items-center">
                                <svg class="h-5 w-5 text-gray-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Observações e Recomendações
                            </h4>
                        </div>
                        <div class="p-6">
                            <textarea id="observations" name="observations" required rows="4"
                                class="block w-full rounded-lg border border-gray-300 bg-white py-2 px-3 focus:border-[var(--orange)] focus:outline-none focus:ring-1 focus:ring-[var(--orange)] sm:text-sm rich-text-editor"
                                placeholder="Adicione observações adicionais, recomendações ou encaminhamentos necessários."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end space-x-3 flex-shrink-0">
                <button type="button" 
                    onclick="closeModal('addConsultModal')"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit"
                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[var(--orange)] hover:bg-[var(--orangeDark)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--orange)] transition-colors duration-200">
                    <svg class="-ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Adicionar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-md">
        <div class="p-6">
            <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="mt-3 text-lg font-medium text-center text-gray-900">Tem certeza?</h3>
            <div class="mt-2 text-sm text-gray-500 text-center">
                <p>Você realmente deseja desativar este prontuário? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="mt-5 flex justify-center space-x-3">
                <button type="button" onclick="closeModal('deleteModal')"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="button" id="confirmDeleteBtn"
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Sim, desativar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let dataTable;
    let consultToDelete = null;

    const style = document.createElement('style');
    style.textContent = `
        .upload-container {
            transition: all 0.2s ease-in-out;
        }
        .upload-container.drag-over {
            border-color: var(--orange);
            background-color: rgba(251, 146, 60, 0.1);
        }
        .file-uploaded {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background-color: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }
        .file-uploaded svg {
            color: #22c55e;
            margin-right: 0.5rem;
        }
    `;
    document.head.appendChild(style);

    $(document).ready(function () {

        // Initialize DataTable with server-side processing disabled
        dataTable = $('#consultsTable').DataTable({
            ajax: {
                url: '/medic/medical_records/data',
                type: 'GET',
            },
            columnDefs: [
            {
                targets: [6],
                className: 'text-center'
            }
        ],
            columns: [
            {
                data: 'id',
                title: 'ID',
                visible: false,
                className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900'
            },
            {
                data: 'patient',
                title: 'Paciente',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                render: function (data) {
                    return data ? data.fullname : 'N/A';
                }
            },
            {
                data: 'medic_history',
                title: 'Histórico Médico',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                render: function (data) {
                    return data ? data.substring(0, 30) + '...' : 'N/A';
                }
            },
            {
                data: 'medicines',
                title: 'Medicamentos',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                render: function (data) {
                    return data ? data.substring(0, 30) + '...' : 'N/A';
                }
            },
            {
                data: 'observations',
                title: 'Observações',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                render: function (data) {
                    return data ? data.substring(0, 30) + '...' : 'N/A';
                }
            },
            {
                data: 'updated_at',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                title: 'Atualizado em',
                render: function (data) {
                    return data ? new Date(data).toLocaleString() : 'N/A';
                }
            },
            {
                data: null,
                orderable: false,
                title: 'Ações',
                className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-center',
                render: function (data, type, row) {
                    return `
                                <div class="flex justify-center space-x-2">
                                    <button onclick="viewConsult(${row.patient.id})" class="text-blue-600 hover:text-blue-900">
                                        <i class="far fa-eye"></i>
                                    </button>
                                    <button onclick="editConsult(${row.patient.id})" class="text-blue-600 hover:text-blue-900">
                                        <i class="far fa-edit"></i>
                                    </button>
                                </div>
                            `;
                }
            }
        ],
            responsive: true,
            order: [[5, 'desc']], // Sort by created_at by default
            language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json',
            search: '_INPUT_',
            searchPlaceholder: 'Buscar...',
            lengthMenu: 'Mostrar _MENU_ itens por página',
            zeroRecords: 'Nenhum registro encontrado',
            info: 'Mostrando _START_ a _END_ de _TOTAL_ itens',
            infoEmpty: 'Mostrando 0 a 0 de 0 itens',
            infoFiltered: '(filtrado de _MAX_ itens no total)',
            paginate: {
                first: "<<",
                last: ">>",
                next: ">",
                previous: "<"
            }
        },
        dom: "<'flex flex-col md:flex-row md:items-center md:justify-between mb-4'<'mb-4 md:mb-0'l><'md:ml-auto'f>>" +
        "<'overflow-x-auto rounded-lg border border-gray-200'rt>" +
        "<'flex flex-col md:flex-row items-center justify-between mt-4'<'mb-4 md:mb-0'i><'flex space-x-2'p>>",
        pageLength: 10,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, 'Todos']],
    });

    $('#addConsultBtn').click(function () {
        $('#addConsultForm')[0].reset();
        openModal('addConsultModal');
    });

    $('#editConsultForm').on('submit', function (e) {
        e.preventDefault();
        const consultId = $('#edit-id').val();
        
        const postData = {
            medic_history: $('#edit-medic_history').val(),
            medicines: $('#edit-medicines').val(),
            observations: $('#edit-observations').val()
        }

        $.ajax({
            url: `/medic/medical_records/${consultId}/edit`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(postData),
            success: function (response) {
                closeModal('editConsultModal');
                window.location.reload();
                return;
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao atualizar paramédico', 'error');
                return;
            }
        });
    });

    $('#confirmDeleteBtn').click(function () {
        if (!consultToDelete) return;

        $.ajax({
            url: `/medic/medical_records/${consultToDelete}/delete`,
            type: 'GET',
            success: function (response) {
                closeModal('deleteModal');
                window.location.reload();
                consultToDelete = null;
                return;
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao deletar consulta', 'error');
            }
        });
    });
    
    });

    function closeModal(modalId) {
        $('#' + modalId).addClass('hidden');
        $('body').removeClass('overflow-hidden');
    }

    function openModal(modalId) {
        $(`#${modalId}`).removeClass('hidden').addClass('flex');
        $('body').addClass('overflow-hidden');
    }

    function viewConsult(consultId) {
        $.ajax({
            url: `/medic/medical_records/${consultId}/data`,
            type: 'GET',
            success: function (response) {
                const consult = response;
                console.log(consult);

                $('#view-patient').text(consult.patient.fullname || 'N/A');
                $('#view-medic_history').text(consult.medic_history || 'N/A');
                $('#view-medicines').text(consult.medicines || 'N/A');
                $('#view-observations').text(consult.observations || 'N/A');
                $('#view-patient-phone').text(consult.patient.phone || 'N/A');
                $('#view-patient-cpf').text(consult.patient.cpf || 'N/A');
                $('#view-patient-email').text(consult.patient.email || 'N/A');
                $('#view-patient-age').text("Idade: " + consult.patient.age || 'N/A');
                $('#view-patient-birthdate').text("Data de Nascimento: " + consult.patient.birthdate || 'N/A');
                $('#view-patient-gender').text("Sexo: " + consult.patient.gender || 'N/A');
                $('#view-patient-address').text(consult.patient.address || 'N/A');
                $('#view-created_at').text(consult.created_at);
                $('#export-pdf-merdical-record').attr('data-id', consult.id);

                openModal('viewConsultModal');
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao visualizar consulta', 'error');
            }
        });
    }

    function editConsult(consultId) {
        $.ajax({
            url: `/medic/medical_records/${consultId}/data`,
            type: 'GET',
            success: function (response) {
                const consult = response;
                console.log(consult);

                // Atualiza os campos do formulário
                $("#edit-id").val(consult.patient.id);
                $("#edit-patient").val(consult.patient.id);
                $("#edit-medic_history").val(consult.medic_history);
                $("#edit-medicines").val(consult.medicines);
                $("#edit-observations").val(consult.observations);
                
                // Abre o modal primeiro
                openModal('editConsultModal');
                
            },
            error: function(xhr) {
                showToast('Erro ao carregar os dados do prontuário', 'error');
                console.error('Erro ao carregar prontuário:', xhr);
            }
        });
    }

    function confirmDelete(consultId) {
        consultToDelete = consultId;
        openModal('deleteModal');
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    function exportMedicalRecord() {
        const consultId = document.querySelector('#export-pdf-merdical-record').getAttribute('data-id');
        console.log(consultId);
        window.location.href = `/medic/medical_records/${consultId}/print`;
    }

</script>

{% endblock %}