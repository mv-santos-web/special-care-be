{% extends "includes/layout.html" %}
{% block title %}Consultas{% endblock %}
{% block styles %}
<style>
    .dataTables_length {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
    }

    .dataTables_length select {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
        margin-left: 5px;
        margin-right: 5px;
        padding: 2px;
        border-radius: 10px !important;
        border: 1px solid var(--orange) !important;
        text-align: center;
    }

    .dataTables_filter input {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
        margin-left: 5px;
        margin-right: 5px;
        padding: 3px;
        border-radius: 10px !important;
        border: 1px solid var(--orange) !important;
    }

    .dataTables_info {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
    }

    /* Pagination Container */
    .dataTables_paginate {
        margin: 0;
        padding: 1rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    /* Pagination Buttons */
    .dataTables_paginate .paginate_button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--blueDark);
        border: 1px solid var(--orange);
        border-radius: 0.375rem !important;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }

    /* Hover State */
    .dataTables_paginate .paginate_button:hover {
        background-color: var(--orange);
        color: white !important;
        border-color: var(--orange);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Active/Current Page */
    .dataTables_paginate .paginate_button.current,
    .dataTables_paginate .paginate_button.current:hover {
        background-color: var(--orange);
        color: white !important;
        border-color: var(--orange);
        font-weight: 800;
    }

    /* Disabled Buttons */
    .dataTables_paginate .paginate_button.disabled,
    .dataTables_paginate .paginate_button.disabled:hover,
    .dataTables_paginate .paginate_button.disabled:active {
        color: var(--orange) !important;
        background-color: var(--orange) !important;
        border-color: var(--orange) !important;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Navigation Buttons (Previous/Next) */
    .dataTables_paginate .paginate_button.previous,
    .dataTables_paginate .paginate_button.next {
        background-color: #f0f0f0 !important;
        border: 1px solid var(--orange) !important;
        color: var(--blueDark) !important;
        font-weight: 800;
        border-radius: 0.375rem !important;
    }

    .dataTables_paginate .paginate_button.previous:hover,
    .dataTables_paginate .paginate_button.next:hover {
        background-color: var(--orange) !important;
        color: white !important;
        border-color: var(--blueDark) !important;
    }

    /* Ellipsis */
    .dataTables_paginate .ellipsis {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--orange);
    }
</style>
{% endblock %}

{% block content %}
<!-- jQuery Mask Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-[var(--blueDark)]">Consultas</h1>
        <p class="text-gray-600">Gerencie as consultas</p>
    </div>
</div>

<!-- Admins Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-4">
        <table id="requestsCareTable" class="w-full">
            <thead>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <!-- Data will be loaded via AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- Attend Consult Modal -->
<div id="attendRequestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Atendimento por Videochamada</h3>
            <button onclick="closeModal('attendRequestModal')" title="Fechar">
                <span class="sr-only">Fechar</span>
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="video-section">
                <div id="jitsiMeetContainer">
                    <span class="text-gray-400">Carregando videochamada...</span>
                </div>
            </div>
            <div class="info-section overflow-y-auto max-h-[calc(100vh-200px)] pr-2">
                <div class="flex flex-col gap-4 mb-4">

                    <!-- Dados do Paciente -->
                    <div class="info-card bg-white rounded-lg shadow p-4 border border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3 pb-2 border-b border-gray-100">Dados do
                            Paciente</h4>
                        <div id="attendPatientData" class="text-sm text-gray-600"></div>
                    </div>

                    <div class="info-card bg-white rounded-lg shadow p-4 border border-gray-200">
                        <div class="flex row gap-4 justify-center">
                            <button type="button" onclick="finalizeRequest()"
                                class="text-md text-white px-4 py-4 rounded-md w-[50%] flex flex-col"
                                style="background-color: var(--blue)">
                                <i class="fa-solid fa-phone-slash"></i> Finalizar
                            </button>
                            <button type="button" onclick="cancelRequest()"
                                class="text-md text-white px-4 py-4 rounded-md w-[50%] flex flex-col"
                                style="background-color: var(--red)">
                                <i class="fa-solid fa-times-circle"></i> Cancelar
                            </button>
                        </div>
                    </div>

                    <!-- Agendar Consulta -->
                    <div class="info-card bg-white rounded-lg shadow p-4 border border-gray-200">
                        <div class="flex justify-between items-center border-b border-gray-100">
                            <h4 class="text-lg font-semibold text-gray-800">Agendar Consulta</h4>
                            <button type="button" onclick="openScheduleForm()"
                                class="text-sm text-white px-3 py-1 rounded-md" style="background-color: #ff914d;">
                                Mostrar
                            </button>
                        </div>

                        <div id="scheduleForm" class="hidden space-y-3">
                            <form onsubmit="scheduleConsultation(event)" class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Médico</label>
                                    <select id="scheduleMedic" required
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        {% for medic in medics %}
                                        <option value="{{ medic.id }}">{{ medic.fullname }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Consulta</label>
                                    <select id="scheduleType" required
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                        <option value="">Selecione o tipo</option>
                                        <option value="teleatendimento">Teleatendimento</option>
                                        <option value="residencial">Residencial</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Data e Hora</label>
                                    <input type="datetime-local" id="scheduleDateTime" required
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent" />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                                    <textarea id="scheduleObs" rows="2" placeholder="Observações para o médico..."
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>

                                <div class="flex gap-2 pt-1">
                                    <button type="submit"
                                        class="flex-1 py-4 text-white text-md rounded-md focus:outline-none focus:ring-2 focus:ring-offset-1"
                                        style="background-color: var(--blue);">
                                        Agendar
                                    </button>

                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Prontuário Médico -->
                    <div class="info-card bg-white rounded-lg shadow p-4 border border-gray-200">
                        <div class="flex justify-between items-center border-b border-gray-100">
                            <h4 class="text-lg font-semibold text-gray-800">Prontuário Médico</h4>
                            <button type="button" onclick="toggleMedicalRecordForm()"
                                class="text-sm text-white px-3 py-1 rounded-md" style="background-color: #ff914d;">
                                Mostrar
                            </button>
                        </div>
                        <form id="medicalRecordForm" onsubmit="saveMedicalRecord(event)" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Histórico Médico</label>
                                <textarea id="medicalHistoryTextarea" rows="3"
                                    placeholder="Histórico médico do paciente..."
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Medicamentos</label>
                                <textarea id="medicinesTextarea" rows="2" placeholder="Medicamentos em uso..."
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                                <textarea id="observationsTextarea" rows="2" placeholder="Observações gerais..."
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                            </div>

                            <div class="flex items-center justify-between pt-2">
                                <button type="submit"
                                    class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                                    Salvar Prontuário
                                </button>
                                <span id="medicalRecordStatus" class="text-sm font-medium text-green-600 hidden">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7" />
                                    </svg>
                                    Salvo!
                                </span>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Admin Modal -->
<div id="editRequestCareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <form id="editRequestCareForm" class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Editar Consulta</h3>
                <button type="button" onclick="closeModal('')" class="text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <input type="hidden" id="edit-id" name="id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="col-span-2">
                    <label for="edit-observations" class="block text-sm font-medium text-gray-700">Observações *</label>
                    <textarea id="edit-observations" name="observations" required rows="8"
                        class="mt-1 p-2 block w-full rounded-md border border-gray-200 bg-gray-50 shadow-sm focus:border-[var(--orange)] focus:ring focus:ring-[var(--orange)] focus:ring-opacity-50 text-gray-900"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeModal('editRequestCareModal')"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="submit"
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[var(--orange)] hover:bg-[var(--orangeDark)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--orange)]">
                    Salvar Alterações
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-md">
        <div class="p-6">
            <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="mt-3 text-lg font-medium text-center text-gray-900">Tem certeza?</h3>
            <div class="mt-2 text-sm text-gray-500 text-center">
                <p>Você realmente deseja desativar esta consulta? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="mt-5 flex justify-center space-x-3">
                <button type="button" onclick="closeModal('deleteModal')"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="button" id="confirmDeleteBtn"
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Sim, desativar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Atendimento (Jitsi + Dados Paciente + Prontuário + Agendamento) -->
<style>
    /* Modal Overlay */
    #attendRequestModal {
        backdrop-filter: blur(2px);
        animation: fadeInModal 0.3s;
    }

    @keyframes fadeInModal {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    /* Modal Container */
    #attendRequestModal .modal-content {
        box-shadow: 0 8px 32px rgba(30, 68, 113, 0.18), 0 1.5px 6px rgba(30, 68, 113, 0.08);
        border-radius: 1.25rem;
        background: #fff;
        max-width: 100vw;
        width: 100%;
        display: flex;
        flex-direction: column;
        max-height: 95vh;
        overflow: hidden;
        padding: 0;
    }

    /* Modal Header */
    #attendRequestModal .modal-header {
        padding: 1.5rem 2rem 1.25rem 2rem;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f9fafb;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 2px 8px -4px rgba(30, 68, 113, 0.04);
    }

    #attendRequestModal .modal-header h3 {
        font-size: 1.35rem;
        font-weight: 700;
        color: var(--blueDark);
        letter-spacing: -0.01em;
    }

    #attendRequestModal .modal-header button {
        background: none;
        border: none;
        color: #647388;
        font-size: 1.5rem;
        transition: color 0.2s;
        border-radius: 50%;
        padding: 0.25rem;
    }

    #attendRequestModal .modal-header button:hover {
        color: var(--orange);
        background: #f3f4f6;
    }

    /* Modal Body */
    #attendRequestModal .modal-body {
        display: flex;
        flex-direction: row;
        gap: 2rem;
        padding: 2rem;
        overflow-y: auto;
        flex: 1;
    }

    @media (max-width: 1024px) {
        #attendRequestModal .modal-body {
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.2rem;
        }
    }

    /* Video Section */
    #attendRequestModal .video-section {
        flex: 2;
        min-width: 400px;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    #jitsiMeetContainer {
        width: 100%;
        height: 100%;
        min-height: 400px;
        background: linear-gradient(135deg, #f3f4f6 60%, #e0e7ef 100%);
        border-radius: 1rem;
        box-shadow: 0 2px 12px -4px #c5cccb33;
        display: flex;
        align-items: stretch;
        justify-content: center;
        margin-bottom: 0.5rem;
        overflow: hidden;
        position: relative;
        flex: 1;
    }

    #jitsiMeetContainer iframe {
        width: 100% !important;
        height: 100% !important;
        min-height: 400px;
        border: none;
        border-radius: 1rem;
        display: block;
        background: #f3f4f6;
    }

    @media (max-width: 1024px) {
        #attendRequestModal .video-section {
            flex: 1;
            min-width: 100%;
        }

        #jitsiMeetContainer {
            min-height: 300px;
        }

        #jitsiMeetContainer iframe {
            min-height: 300px;
        }
    }

    @media (max-width: 900px) {
        #jitsiMeetContainer {
            min-height: 250px;
            max-height: 60vh;
        }

        #jitsiMeetContainer iframe {
            min-height: 250px;
        }
    }

    @media (max-width: 600px) {
        #jitsiMeetContainer {
            min-height: 200px;
            max-height: 45vh;
        }

        #jitsiMeetContainer iframe {
            min-height: 200px;
        }
    }

    /* Agendamento */
    #attendRequestModal .schedule-btn {
        width: 100%;
        background: var(--blue);
        color: #fff;
        font-weight: 600;
        padding: 0.7rem 0;
        border-radius: 0.75rem;
        font-size: 1rem;
        margin-bottom: 0.5rem;
        transition: background 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px -4px #1e447133;
    }

    #attendRequestModal .schedule-btn:hover {
        background: var(--orange);
        color: #fff;
    }

    #scheduleForm {
        background: #f9fafb;
        border-radius: 0.75rem;
        padding: 1rem 1.2rem;
        box-shadow: 0 2px 8px -4px #1e447133;
        margin-bottom: 0.5rem;
    }

    #scheduleForm input[type="datetime-local"] {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.5rem;
        font-size: 1rem;
        margin-bottom: 0.5rem;
        width: 100%;
    }

    /* Dados e Prontuário */
    #attendRequestModal .info-section {
        flex: 1;
        min-width: 300px;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        height: 100%;
    }

    #attendRequestModal .info-card {
        background: #f3f4f6;
        border-radius: 0.75rem;
        padding: 1.2rem 1rem 1rem 1rem;
        box-shadow: 0 2px 8px -4px #1e447133;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    #attendRequestModal .info-card h4 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--blueDark);
        margin-bottom: 0.5rem;
    }

    #attendPatientData div {
        margin-bottom: 0.3rem;
        font-size: 1rem;
        color: #374151;
    }

    /* Prontuário */
    #medicalRecordForm {
        flex: 1;
        flex-direction: column;
    }

    #medicalRecordForm textarea {
        width: 100%;
        border: 1.5px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.7rem;
        font-size: 1rem;
        background: #fff;
        min-height: 100px;
        margin-bottom: 0.5rem;
        transition: border 0.2s;
        flex: 1;
        resize: vertical;
    }

    #medicalRecordForm textarea:focus {
        border: 1.5px solid var(--orange);
        outline: none;
        background: #fef9f6;
    }

    #medicalRecordForm .actions {
        display: flex;
        gap: 0.7rem;
        align-items: center;
    }

    #medicalRecordForm button[type="submit"] {
        background: var(--orange);
        color: #fff;
        font-weight: 600;
        border-radius: 0.5rem;
        padding: 0.5rem 1.2rem;
        font-size: 1rem;
        transition: background 0.2s;
        box-shadow: 0 2px 8px -4px #f46e2433;
    }

    #medicalRecordForm button[type="submit"]:hover {
        background: var(--orangeDark);
    }

    #medicalRecordStatus {
        font-size: 0.95rem;
        color: #22c55e;
        font-weight: 500;
        margin-left: 0.5rem;
    }

    /* Scrollbar custom */
    #attendRequestModal .modal-body::-webkit-scrollbar {
        width: 8px;
        background: #f3f4f6;
        border-radius: 8px;
    }

    #attendRequestModal .modal-body::-webkit-scrollbar-thumb {
        background: #e5e7eb;
        border-radius: 8px;
    }
</style>

<script>
    let dataTable;
    let requestCareToDelete = null;
    let patient_data = null;
    let medical_records = null;

    // Estilos para drag and drop
    const style = document.createElement('style');
    style.textContent = `
        .upload-container {
            transition: all 0.2s ease-in-out;
        }
        .upload-container.drag-over {
            border-color: var(--orange);
            background-color: rgba(251, 146, 60, 0.1);
        }
        .file-uploaded {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background-color: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }
        .file-uploaded svg {
            color: #22c55e;
            margin-right: 0.5rem;
        }
    `;
    document.head.appendChild(style);

    // Função para aplicar máscaras
    function applyMasks() {
        // Máscara para telefone (00) 00000-0000
        $('#phone').mask('(00) 00000-0000');

        // Máscara para CPF 000.000.000-00
        $('#cpf').mask('000.000.000-00');

    }

    $(document).ready(function () {
        // Aplicar máscaras quando o documento estiver pronto
        applyMasks();

        // Reaplicar máscaras quando o modal for aberto
        $('#addRequestCareModal').on('shown.bs.modal', function () {
            applyMasks();
        });

        // Initialize DataTable with server-side processing disabled
        dataTable = $('#requestsCareTable').DataTable({
            ajax: {
                url: '/medic/consults/data',
                type: 'GET'
            },
            columnDefs: [
            {
                targets: [6],
                className: 'text-center'
            }
        ],
            columns: [
            {
                data: 'id',
                className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900',
                visible: false  // Hide ID column by default
            },
            {
                data: 'patient.fullname',
                className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900',
                title: 'Paciente'
            },
            {
                data: 'nurse.fullname',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                title: 'Enfermeira',
                render: function (data) {
                    return data || 'N/A';
                }
            },
            {
                data: 'observations',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                title: 'Observações',
                render: function (data) {
                    if (data.length > 20) {
                        return data.substring(0, 20) + '...';
                    }
                    return data || 'N/A';
                }
            },
            {
                data: 'status',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                title: 'Status',
                render: function (data, type, row) {

                    if (data === 'pending') {
                        return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pendente</span>';
                    }

                    if (data === 'accepted') {
                        return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Aceito</span>';
                    }

                    if (data === 'rejected') {
                        return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Recusado</span>';
                    }

                    if (data === 'completed') {
                        return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Concluído</span>';
                    }

                    if (data === 'cancelled') {
                        return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Cancelado</span>';
                    }
                }
            },
            {
                data: 'create_at',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                title: 'Criado em',
                width: '15%',
                render: function (data) {
                    return data ? data : 'N/A';
                }
            },
            {
                data: null,
                orderable: false,
                className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-center',
                title: 'Ações',
                width: '10%',
                render: function (data, type, row) {
                    // Ensure we have a valid row ID
                    if (!row || row.id === undefined) return '';

                    return `
                                <div class="flex justify-center space-x-3">
                                    <button onclick="attendConsult(${row.id}); return false;" 
                                        class="text-blue-600 hover:text-blue-800 transition-colors" 
                                        title="Atender">
                                        <i class="fas fa-phone-alt"></i>
                                    </button>
                                    <button onclick="editRequestCare(${row.id}); return false;" 
                                        class="text-yellow-600 hover:text-yellow-800 transition-colors" 
                                        title="Editar">
                                        <i class="far fa-edit"></i>
                                    </button>
                                    <button onclick="confirmDelete(${row.id}); return false;" 
                                        class="text-red-600 hover:text-red-800 transition-colors" 
                                        title="Excluir">
                                        <i class="far fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                }
            }
        ],
            responsive: true,
            order: [[5, 'desc']], // Sort by created_at by default
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json',
                search: '_INPUT_',
                searchPlaceholder: 'Buscar...',
                lengthMenu: 'Mostrar _MENU_ itens por página',
                zeroRecords: 'Nenhum registro encontrado',
                info: 'Mostrando _START_ a _END_ de _TOTAL_ itens',
                infoEmpty: 'Mostrando 0 a 0 de 0 itens',
                infoFiltered: '(filtrado de _MAX_ itens no total)',
                paginate: {
                    first: "<<",
                    last: ">>",
                    next: ">",
                    previous: "<"
                }
            },
            dom: "<'flex flex-col md:flex-row md:items-center md:justify-between mb-4'<'mb-4 md:mb-0'l><'md:ml-auto'f>>" +
            "<'overflow-x-auto rounded-lg border border-gray-200'rt>" +
            "<'flex flex-col md:flex-row items-center justify-between mt-4'<'mb-4 md:mb-0'i><'flex space-x-2'p>>",
            pageLength: 10,
            lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, 'Todos']],
                
        });
    });

    $('#addRequestCareBtn').click(function () {
        $('#addRequestCareForm')[0].reset();
        openModal('addRequestCareModal');
    });

    $('#editRequestCareForm').on('submit', function (e) {
        e.preventDefault();
        const requestCareId = $('#edit-id').val();
        const formData = $(this).serialize();

        $.ajax({
            url: `/medic/consult/${requestCareId}`,
            type: 'POST',
            data: formData,
            success: function (response) {
                closeModal('editRequestCareModal');
                window.location.reload();
                return;
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao atualizar pedido de cuidado', 'error');
                return;
            }
        });
    });

    $('#confirmDeleteBtn').click(function () {
        if (!requestCareToDelete) return;

        $.ajax({
            url: `/medic/consult/${requestCareToDelete}/delete`,
            type: 'GET',
            success: function (response) {
                closeModal('deleteModal');
                window.location.reload();
                requestCareToDelete = null;
                return;
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao deletar pedido de cuidado', 'error');
            }
        });
    });

    function openJitsiMeet(roomName) {
        // Limpar container
        const container = document.getElementById('jitsiMeetContainer');
        container.innerHTML = '';

        // Configurações do Jitsi com dados do enfermeiro
        const domain = 'meet.jit.si';
        const options = {
            roomName: `specialcare-consult-${roomName}`,
            width: '100%',
            height: '100%',
            parentNode: container,
            userInfo: {
                displayName: '{{ current_user.fullname }}',
                email: '{{ current_user.email }}'
            },
            configOverwrite: {
                // Desabilitar autenticação
                guestDialOut: false,
                guestDialOutUrl: false,

                // Configurações de interface
                SHOW_JITSI_WATERMARK: false,
                SHOW_WATERMARK_FOR_GUESTS: false,
                SHOW_POWERED_BY: false,

                // Configurações de áudio/vídeo
                startAudioOnly: false,
                startVideoMuted: false,
                startWithAudioMuted: false,

                // Configurações de sala
                prejoinPageEnabled: true,

                // Configurações de segurança
                disableModeratorIndicator: false,

                // Configurações de qualidade
                maxFullResolutionParticipants: 2,

                // Configurações de notificações
                notifications: ['raise-hand'],

                // Configurações de anfitrião/moderador
                hosts: {
                    // Define o enfermeiro como anfitrião
                    domain: 'meet.jit.si'
                },

                // Configurações de privilégios
                startWithAudioMuted: false,
                startWithVideoMuted: false,

                // Configurações de sala
                roomPassword: null,

                // Configurações de permissões
                disableModeratorIndicator: false,

                // Configurações de controle
                enableClosePage: false,

                // Configurações de gravação (apenas para anfitrião)
                fileRecordingsEnabled: false,
                liveStreamingEnabled: false,

                // Configurações de chat (anfitrião pode moderar)
                chatEnabled: false,

                // Configurações de participantes
                maxParticipants: 2,

                // Configurações de segurança
                securityOptions: {
                    // Anfitrião pode expulsar participantes
                    kickParticipants: true,
                    // Anfitrião pode silenciar todos
                    muteEveryone: true,
                    // Anfitrião pode desativar chat
                    disableChat: true
                }
            },
            interfaceConfigOverwrite: {
                // Interface limpa
                SHOW_JITSI_WATERMARK: false,
                SHOW_WATERMARK_FOR_GUESTS: false,
                SHOW_POWERED_BY: false,

                // Configurações de toolbar
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera'
                ],

                // Configurações visuais
                SHOW_BRAND_WATERMARK: false,
                SHOW_PROMOTIONAL_LINK: false,

                // Configurações de chat
                CHAT_WRITE_AVATAR: false,

                // Configurações de participantes
                SHOW_PARTICIPANT_AVATAR: true,

                // Configurações de qualidade
                VIDEO_QUALITY_LABEL: false,

                // Configurações de layout
                TILE_VIEW_MAX_COLUMNS: 2,

                // Configurações de notificações
                NOTIFICATION_TIMEOUT: 5000,

                // Configurações de anfitrião
                SHOW_MODERATOR_INDICATOR: true,
                SHOW_HOST_INDICATOR: true,

                // Configurações de controle administrativo
                ADMIN_TOOLBAR_BUTTONS: [
                    'mute-everyone', 'kick-participant', 'disable-chat',
                    'lock-room', 'unlock-room', 'set-password'
                ],

                // Configurações de sala
                SHOW_ROOM_NAME: false,
                SHOW_PARTICIPANT_COUNT: false,

                // Configurações de gravação
                SHOW_RECORDING_INDICATOR: false,
                SHOW_LIVE_STREAMING_INDICATOR: false,

                // Configurações de segurança
                SHOW_SECURITY_OPTIONS: true,

                // Configurações de qualidade
                SHOW_VIDEO_QUALITY_INDICATOR: false,

                // Configurações de dispositivos
                SHOW_DEVICE_SETTINGS: false,

                // Configurações de ajuda
                SHOW_HELP_BUTTON: false,

                // Configurações de feedback
                SHOW_FEEDBACK_BUTTON: false
            }
        };

        // Carregar script Jitsi se não existir
        if (!window.JitsiMeetExternalAPI) {
            const script = document.createElement('script');
            script.src = 'https://meet.jit.si/external_api.js';
            script.onload = () => {
                window.jitsiApi = new window.JitsiMeetExternalAPI(domain, options);

                // Eventos do Jitsi
                window.jitsiApi.addEventListeners({
                    'videoConferenceJoined': () => {
                        console.log('Enfermeiro entrou na videochamada');
                    },
                    'participantJoined': (id, participant) => {
                        console.log('Participante entrou:', participant.displayName);
                    },
                    'participantLeft': (id, participant) => {
                        console.log('Participante saiu:', participant.displayName);
                    },
                    'videoConferenceLeft': () => {
                        console.log('Enfermeiro saiu da videochamada');
                    }
                });
            };
            document.body.appendChild(script);
        } else {
            window.jitsiApi = new window.JitsiMeetExternalAPI(domain, options);

            // Eventos do Jitsi
            window.jitsiApi.addEventListeners({
                'videoConferenceJoined': () => {
                    console.log('Enfermeiro entrou na videochamada');
                },
                'participantJoined': (id, participant) => {
                    console.log('Participante entrou:', participant.displayName);
                },
                'participantLeft': (id, participant) => {
                    console.log('Participante saiu:', participant.displayName);
                },
                'videoConferenceLeft': () => {
                    console.log('Enfermeiro saiu da videochamada');
                }
            });
        }
    }

    function closeAttendModal() {
        document.getElementById('consultModal').classList.add('hidden');
        document.getElementById('consultModal').classList.remove('flex');
        // Destruir a instância do Jitsi se existir
        if (window.jitsiApi) {
            window.jitsiApi.dispose();
            window.jitsiApi = null;
        }
    }

    function openModal(modalId) {
        $(`#${modalId}`).removeClass('hidden').addClass('flex');
        $('body').addClass('overflow-hidden');
    }

    function closeModal(modalId) {
        $(`#${modalId}`).addClass('hidden').removeClass('flex');
        $('body').removeClass('overflow-hidden');
    }

    function viewRequestCare(requestCareId) {
        $.ajax({
            url: `/medic/consult/${requestCareId}`,
            type: 'GET',
            success: function (response) {
                const requestCare = response;
                $('#view-patient-fullname').text(requestCare.patient.fullname);
                $('#view-nurse-fullname').text(requestCare.nurse?.fullname || 'N/A');
                $('#view-description').text(requestCare.observations);
                $('#view-consult_type').text(requestCare.consult_type.charAt(0).toUpperCase() + requestCare.consult_type.slice(1));
                $('#view-created_at').text(requestCare.date);
                const statusElement = $('#view-status span');
                statusElement.removeClass('bg-green-100 text-green-800 bg-red-100 text-red-800');

                if (requestCare.status === 'pending') {
                    statusElement.addClass('bg-yellow-100 text-yellow-800').text('Pendente');
                } else if (requestCare.status === 'accepted') {
                    statusElement.addClass('bg-green-100 text-green-800').text('Aceito');
                } else if (requestCare.status === 'rejected') {
                    statusElement.addClass('bg-red-100 text-red-800').text('Recusado');
                } else if (requestCare.status === 'completed') {
                    statusElement.addClass('bg-green-100 text-green-800').text('Concluído');
                } else if (requestCare.status === 'cancelled') {
                    statusElement.addClass('bg-red-100 text-red-800').text('Cancelado');
                }

                openModal('viewRequestCareModal');
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao visualizar pedido de cuidado', 'error');
            }
        });
    }

    function editRequestCare(requestCareId) {
        $("#edit-id").val(requestCareId);
        $.ajax({
            url: `/medic/consult/${requestCareId}`,
            type: 'GET',
            success: function (response) {
                const requestCare = response;
                $('#edit-id').val(requestCare.id);
                $('#edit-patient').val(requestCare.patient_id);
                $('#edit-nurse').val(requestCare.nurse_id);
                $('#edit-description').val(requestCare.description);
                $('#edit-status').val(requestCare.status);

                openModal('editRequestCareModal');
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao carregar dados do pedido de cuidado', 'error');
            }
        });
    }

    function confirmDelete(requestCareId) {
        console.log("ID", requestCareId)
        requestCareToDelete = requestCareId;
        openModal('deleteModal');
    }

    function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    function attendConsult(consultId) {
        consultToDelete = consultId;
        fetch(`/medic/consult/${consultId}`)
            .then(response => response.json())
            .then(data => {
                patient_data = data.patient;
                const patientData = `
                    <div><b>Nome:</b> ${data.patient.fullname}</div>
                    <div><b>Data de Nascimento:</b> ${data.patient.birthdate || '-'}</div>
                    <div><b>CPF:</b> ${data.patient.cpf || '-'}</div>
                    <div><b>Email:</b> ${data.patient.email || '-'}</div>
                    <div><b>Telefone:</b> ${data.patient.phone || '-'}</div>
                `;
                document.getElementById('attendPatientData').innerHTML = patientData;
            })
            .catch(error => {
                console.error('Erro ao carregar dados do paciente:', error);
            });

        fetch(`/medic/prontuario_by_patient/${patient_data.id}`)
            .then(response => response.json())
            .then(data => {
                console.log("Medical Records:", data);
                medical_records = data;
                document.getElementById('medicalHistoryTextarea').value = data.medical_history || '';
                document.getElementById('medicinesTextarea').value = data.medicines || '';
                document.getElementById('observationsTextarea').value = data.observations || '';
            })
            .catch(error => {
                console.error('Erro ao carregar dados do paciente:', error);
            });
        openModal('attendRequestModal');
        openJitsiMeet(consultId);
    }

</script>

{% endblock %}