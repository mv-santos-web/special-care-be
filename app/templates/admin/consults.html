{% extends "includes/layout.html" %}
{% block title %}Consultas{% endblock %}
{% block styles %}
<style>
    .dataTables_length {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
    }

    .dataTables_length select {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
        margin-left: 5px;
        margin-right: 5px;
        padding: 2px;
        border-radius: 10px !important;
        border: 1px solid var(--orange) !important;
        text-align: center;
    }

    .dataTables_filter input {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
        margin-left: 5px;
        margin-right: 5px;
        padding: 3px;
        border-radius: 10px !important;
        border: 1px solid var(--orange) !important;
    }

    .dataTables_info {
        font-size: 15px;
        color: var(--blueDark);
        font-weight: 500;
    }

    /* Pagination Container */
    .dataTables_paginate {
        margin: 0;
        padding: 1rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    /* Pagination Buttons */
    .dataTables_paginate .paginate_button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--blueDark);
        border: 1px solid var(--orange);
        border-radius: 0.375rem !important;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }

    /* Hover State */
    .dataTables_paginate .paginate_button:hover {
        background-color: var(--orange);
        color: white !important;
        border-color: var(--orange);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Active/Current Page */
    .dataTables_paginate .paginate_button.current,
    .dataTables_paginate .paginate_button.current:hover {
        background-color: var(--orange);
        color: white !important;
        border-color: var(--orange);
        font-weight: 800;
    }

    /* Disabled Buttons */
    .dataTables_paginate .paginate_button.disabled,
    .dataTables_paginate .paginate_button.disabled:hover,
    .dataTables_paginate .paginate_button.disabled:active {
        color: var(--orange) !important;
        background-color: var(--orange) !important;
        border-color: var(--orange) !important;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Navigation Buttons (Previous/Next) */
    .dataTables_paginate .paginate_button.previous,
    .dataTables_paginate .paginate_button.next {
        background-color: #f0f0f0 !important;
        border: 1px solid var(--orange) !important;
        color: var(--blueDark) !important;
        font-weight: 800;
        border-radius: 0.375rem !important;
    }

    .dataTables_paginate .paginate_button.previous:hover,
    .dataTables_paginate .paginate_button.next:hover {
        background-color: var(--orange) !important;
        color: white !important;
        border-color: var(--blueDark) !important;
    }

    /* Ellipsis */
    .dataTables_paginate .ellipsis {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--orange);
    }
</style>
{% endblock %}

{% block content %}
<!-- jQuery Mask Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<div class="mb-6 flex justify-between items-center">
    <div>
        <h1 class="text-2xl font-bold text-[var(--blueDark)]">Consultas</h1>
        <p class="text-gray-600">Gerencie as consultas do sistema</p>
    </div>

    <!-- Add New Admin Button
    <div>
        <button id="addConsultBtn"
            class="bg-[var(--orange)] hover:bg-[var(--orangeDark)] text-white px-4 py-2 rounded-lg flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
                </path>
            </svg>
            Nova Consulta
        </button>
    </div> -->
</div>
<!-- Admins Table -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-4">
        <table id="consultsTable" class="w-full">
            <thead>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <!-- Data will be loaded via AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- View Admin Modal -->
<div id="viewConsultModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Detalhes da Consulta</h3>
                <button onclick="closeModal('viewConsultModal')" class="text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-500">Paciente</label>
                    <p id="view-patient" class="mt-1 text-gray-900"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500">Médico</label>
                    <p id="view-medic" class="mt-1 text-gray-900"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500">Enfermeira</label>
                    <p id="view-nurse" class="mt-1 text-gray-900"></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500">Status</label>
                    <p id="view-status" class="mt-1"><span
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"></span></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500">Data de Criação</label>
                    <p id="view-created_at" class="mt-1 text-gray-900"></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeModal('viewConsultModal')"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl w-full max-w-md">
        <div class="p-6">
            <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="mt-3 text-lg font-medium text-center text-gray-900">Tem certeza?</h3>
            <div class="mt-2 text-sm text-gray-500 text-center">
                <p>Você realmente deseja desativar esta consulta? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="mt-5 flex justify-center space-x-3">
                <button type="button" onclick="closeModal('deleteModal')"
                    class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Cancelar
                </button>
                <button type="button" id="confirmDeleteBtn"
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Sim, desativar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let dataTable;
    let consultToDelete = null;

    // Estilos para drag and drop
    const style = document.createElement('style');
    style.textContent = `
        .upload-container {
            transition: all 0.2s ease-in-out;
        }
        .upload-container.drag-over {
            border-color: var(--orange);
            background-color: rgba(251, 146, 60, 0.1);
        }
        .file-uploaded {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background-color: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 0.375rem;
            margin-top: 0.5rem;
        }
        .file-uploaded svg {
            color: #22c55e;
            margin-right: 0.5rem;
        }
    `;
    document.head.appendChild(style);

    // Função para aplicar máscaras
    function applyMasks() {
        // Máscara para telefone (00) 00000-0000
        $('#phone').mask('(00) 00000-0000');

        // Máscara para CPF 000.000.000-00
        $('#cpf').mask('000.000.000-00');

    }

    $(document).ready(function () {
        // Aplicar máscaras quando o documento estiver pronto
        applyMasks();

        // Reaplicar máscaras quando o modal for aberto
        $('#addConsultModal').on('shown.bs.modal', function () {
            applyMasks();
        });

        // Initialize DataTable with server-side processing disabled
        dataTable = $('#consultsTable').DataTable({
            ajax: {
                url: '/admin/consults/data',
                type: 'GET'
            },
            columnDefs: [
            {
                targets: [6],
                className: 'text-center'
            }
        ],
            columns: [
            {
                data: 'id',
                title: 'ID',
                visible: false,
                className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900'
            },
            {
                data: 'patient',
                title: 'Paciente',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                render: function (data) {
                    return data ? data.fullname : 'N/A';
                }
            },
            {
                data: 'medic',
                title: 'Medico',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                render: function (data) {
                    return data ? data.fullname : 'N/A';
                }
            },
            {
                data: 'nurse',
                title: 'Enfermeiro',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                render: function (data) {
                    return data ? data.fullname : 'N/A';
                }
            },
            {
                data: 'status',
                title: 'Status',
                className: 'px-6 py-4 whitespace-nowrap',
                render: function (data) {
                    let statusClass = '';
                    switch (data) {
                        case 'completed':
                            statusClass = 'bg-green-100 text-green-800';
                            statusText = 'Atendida';
                            break;
                        case 'accepted':
                            statusClass = 'bg-green-100 text-green-800';
                            statusText = 'Aceita';
                            break;
                        case 'in_progress':
                            statusClass = 'bg-blue-100 text-blue-800';
                            statusText = 'Em Atendimento';
                            break;
                        case 'solicited':
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            statusText = 'Solicitada';
                            break;
                        case 'cancelled':
                            statusClass = 'bg-red-100 text-red-800';
                            statusText = 'Cancelada';
                            break;
                        default:
                            statusClass = 'bg-gray-100 text-gray-800';
                            statusText = 'Pendente';
                    }
                    return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>`;
                }
            },
            {
                data: 'date',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                title: 'Data da Consulta',
                render: function (data) {
                    return data ? data : 'N/A';
                }
            },
            {
                data: 'create_at',
                className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-500',
                title: 'Solicitado em',
                render: function (data) {
                    return data ? data : 'N/A';
                }
            },
            {
                data: null,
                orderable: false,
                title: 'Ações',
                className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-center',
                render: function (data, type, row) {
                    return `
                                <div class="flex justify-center space-x-2">
                                    <button onclick="viewConsult(${row.id})" class="text-blue-600 hover:text-blue-900">
                                        <i class="far fa-eye"></i>
                                    </button>
                                    <button onclick="confirmDelete(${row.id})" class="text-red-600 hover:text-red-900">
                                        <i class="far fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                }
            }
        ],
            responsive: true,
            order: [[5, 'desc']], // Sort by created_at by default
            language: {
            url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json',
            search: '_INPUT_',
            searchPlaceholder: 'Buscar...',
            lengthMenu: 'Mostrar _MENU_ itens por página',
            zeroRecords: 'Nenhum registro encontrado',
            info: 'Mostrando _START_ a _END_ de _TOTAL_ itens',
            infoEmpty: 'Mostrando 0 a 0 de 0 itens',
            infoFiltered: '(filtrado de _MAX_ itens no total)',
            paginate: {
                first: "<<",
                last: ">>",
                next: ">",
                previous: "<"
            }
        },
        dom: "<'flex flex-col md:flex-row md:items-center md:justify-between mb-4'<'mb-4 md:mb-0'l><'md:ml-auto'f>>" +
        "<'overflow-x-auto rounded-lg border border-gray-200'rt>" +
        "<'flex flex-col md:flex-row items-center justify-between mt-4'<'mb-4 md:mb-0'i><'flex space-x-2'p>>",
        pageLength: 10,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, 'Todos']],
    });

    $('#addConsultBtn').click(function () {
        $('#addConsultForm')[0].reset();
        openModal('addConsultModal');
    });

    $('#editConsultForm').on('submit', function (e) {
        e.preventDefault();
        const consultId = $('#edit-id').val();
        const formData = $(this).serialize();
        const jsonData = {
            id: consultId,
            patient_id: $('#edit-patient').val(),
            medic_id: $('#edit-medic').val(),
            date: $('#edit-date').val(),
            status: $('#edit-status').val()
        }

        $.ajax({
            url: `/admin/consults/${consultId}/edit`,
            type: 'POST',
            data: JSON.stringify(jsonData),
            contentType: 'application/json',
            success: function (response) {
                closeModal('editConsultModal');
                window.location.reload();
                return;
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao atualizar paramédico', 'error');
                return;
            }
        });
    });

    $('#confirmDeleteBtn').click(function () {
        if (!consultToDelete) return;

        $.ajax({
            url: `/admin/consults/${consultToDelete}/delete`,
            type: 'GET',
            success: function (response) {
                closeModal('deleteModal');
                window.location.reload();
                consultToDelete = null;
                return;
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao deletar consulta', 'error');
                return;
            }
        });
    });
    
    });

    function openModal(modalId) {
        $(`#${modalId}`).removeClass('hidden').addClass('flex');
        $('body').addClass('overflow-hidden');
    }

    function closeModal(modalId) {
        $(`#${modalId}`).addClass('hidden').removeClass('flex');
        $('body').removeClass('overflow-hidden');
    }

    function viewConsult(consultId) {
        $.ajax({
            url: `/admin/consults/${consultId}/view`,
            type: 'GET',
            success: function (response) {
                const consult = response;
                console.log(consult);

                $('#view-patient').text(consult.patient.fullname || 'N/A');
                $('#view-medic').text(consult.medic.fullname || 'N/A');
                $('#view-nurse').text(consult.nurse.fullname || 'N/A');
                $('#view-created_at').text(consult.created_at);

                const statusElement = $('#view-status span');
                statusElement.removeClass('bg-green-100 text-green-800 bg-red-100 text-red-800');

                if (consult.status === 'completed') {
                    statusElement.addClass('bg-green-100 text-green-800').text('Atendida');
                } else if (consult.status === 'in_transit') {
                    statusElement.addClass('bg-blue-100 text-blue-800').text('Em Trânsito');
                } else if (consult.status === 'accepted') {
                    statusElement.addClass('bg-green-100 text-green-800').text('Aceita');
                } else if (consult.status === 'solicited') {
                    statusElement.addClass('bg-yellow-100 text-yellow-800').text('Solicitada');
                } else if (consult.status === 'cancelled') {
                    statusElement.addClass('bg-red-100 text-red-800').text('Cancelada');
                } else if (consult.status === 'in_progress') {
                    statusElement.addClass('bg-blue-100 text-blue-800').text('Em Atendimento');
                } else {
                    statusElement.addClass('bg-blue-100 text-blue-800').text('Status desconhecido');
                }

                openModal('viewConsultModal');
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao visualizar consulta', 'error');
            }
        });
    }

    function editConsult(consultId) {
        $.ajax({
            url: `/admin/consults/${consultId}/view`,
            type: 'GET',
            success: function (response) {
                const consult = response;
                console.log(consult);

                $("#edit-id").val(consult.id);
                $("#edit-patient").val(consult.patient.id);
                $("#edit-medic").val(consult.medic.id);
                $("#edit-nurse").val(consult.nurse.id);
                $("#edit-status").val(consult.status);
                $("#edit-sollicitation_date").val(consult.sollicitation_date);
                $("#edit-accepted_at").val(consult.accepted_at);

                openModal('editConsultModal');
            },
            error: function (xhr) {
                const error = xhr.responseJSON || {};
                showToast(error.message || 'Erro ao carregar dados do consulta', 'error');
            }
        });
    }

    function confirmDelete(consultId) {
        consultToDelete = consultId;
        openModal('deleteModal');
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

</script>

{% endblock %}